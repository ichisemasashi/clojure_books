\section{値のフィルタリングと削除}

惑星のコレクションではなく、太陽系内の全エンティティのコレクションを渡されることもある。その場合、月の総数を計算するには、惑星だけをフィルタリングして月の数を抽出し、月の総数を計算する必要がある。まずはシーケンスを使ってどのように見えるか見てみましょう。


\begin{lstlisting}[numbers=none]
(defn planet?
  [entity]
  (instance? Planet entity))

(defn total-moons
  [entities]
  (reduce + 0
    (map :moons
      (filter planet?
        entities))))
\end{lstlisting}


エンティティが惑星であるかどうかをテストする\texttt{planet?}ヘルパー関数を定義しました。Clojureでは、真偽の値を返す関数は述語と呼ばれます。それらはしばしば \texttt{?} で終わる名前を与えられます。一般的に、あなたが定義するほとんどのドメインは、いくつかのヘルパー述語を 持っています。

一連のシーケンス変換をネストするとき、しばしば、スレッドラストマクロ \texttt{->>} を使うと便利です。このマクロは、前の例のようにインサイドアウトではなく、一連の変換を順番に読むことができるようにコードを再構築する。

同じ例を \texttt{->>} で書き直すと、各式の結果を次の式の最後の位置に「通す」ようになります。すべてのシーケンス式は入力シーケンスを最終引数として受け取るので、ほとんどの入れ子になったシーケンス変換とうまく連動することができます。


\begin{lstlisting}[numbers=none]
(defn total-moons
  [entities]
  (->> entities
       (filter planet?)
       (map :moons)
       (reduce + 0)))
\end{lstlisting}

これで、\texttt{filter}、\texttt{map}、\texttt{reduce}の順に適用される関数をトップダウンで読むことができるようになりました。

トランスデューサーで同じ結果を得るには、最初の2つの変換（\texttt{filter}と\texttt{map}）を合成して、\texttt{transduce}で適用する必要があります。各トランスデューサーはスタックのように前のものを包むので、スレッドラストマクロと同じトップダウンの適用順序で関数を構成するために \texttt{comp} を使うことができます。

\begin{lstlisting}[numbers=none]
(def moons-transform
  (comp (filter planet?) (map :moons)))

(defn total-moons
  [entities]
  (transduce moons-transform + 0 entities))
\end{lstlisting}

構成された変換を作成した後、\texttt{transduce} からそれを呼び出すのは簡単でした。ここでも、この関数のシーケンス版と比較して、いくつか注目すべき点があります。まず、合成変換は太陽系内の惑星から月だけを返します。この変換は、エンティティが別の入力ソースから来る別の計算で再利用することができます。

シーケンスバージョンでは、まずエンティティのコレクションを生成し、次に惑星だけの小さなシーケンスを生成し、最後に月の数のシーケンスを生成します。各中間シーケンスでは、オブジェクトが割り当てられ、メモリが消費される。Transducerバージョンでは、単一の複合変換を使用し、ソース入力にシングルパスで適用されます。ここでの節約はわずかですが、多数の変換と数千のエンティティを含む実際の使用では、パフォーマンスの向上は大きなものです。

しかし、他の使用例では、怠惰が重要な属性となり得ることを心に留めておいてください。そのような場合は、シーケンス版の方が好ましい。

コレクションをフィルタリングする関数には、\texttt{filter}の他に\texttt{remove}と\texttt{keep}があります。\texttt{remove}関数は\texttt{filter}の逆で、残すべき値ではなく、取り除くべき値を指定します。\texttt{keep}関数は、\texttt{map}と\texttt{filter}の機能を一つの便利なパッケージにまとめたもので、各要素に関数を適用し、\texttt{nil}でない結果を保持します。