[UP](000_00.md)

### レッスン2：JavaScriptエコシステムの中のClojureScript

ClojureScriptとは何か、どのように使うのかを理解したところで、引き続きカーテンを引いて、この不思議な言語がその環境、つまりJavaScriptのエコシステムにどのように適合するのかを明確に把握していきます。この言語はJavaScriptとは全く異なるものですが、JavaScriptのホストとは共生関係を保っています。JavaScriptはClojureScriptを必要とし、ClojureScriptはJavaScriptを必要としています。この興味深い共生関係を探ってみましょう。

-----
**このレッスンでは**

- ClojureScriptは、JavaScriptのどんな問題を解決しようとしているのか？
- コンパイルされた言語を使うことは、アプリケーション開発にどのように役立つか
- なぜJavaScriptはClojureScriptの理想的なプラットフォームなのか？
-----

#### JavaScriptがClojureを必要とする理由

ClojureScriptのスイートスポットを見れば、ClojureScriptが約束する利益があることは明らかでしょう。しかし、新しい言語を学ぶことなく、JavaScript自体から同様の利点を得ることができるでしょうか？また、ClojureScriptは、日々の開発作業において、本当にそれほどの付加価値を与えてくれるのでしょうか。ClojureScriptは、些細な作業には最適なツールではないかもしれませんが、より複雑な作業には、より生産的で楽しい開発を可能にするClojureのような言語が、実際にはJavaScriptには必要なのです。

> Clojure(Script)
> 
>    私が「Clojure」と「ClojureScript」という言葉を入れ替えて使っていることに何度か気づいたかもしれません。言語としてのClojureには、JavaバイトコードとJavaScriptの両方にコンパイルできる実装があります。潜在的な混乱は、「Clojure」が言語とそのJava実装の両方を指していることに起因しています。ここでは、Clojureコミュニティの一般的なパターンに従って、言語自体について話すときはこの2つの用語を互換的に使用し、エコシステムやClojureScriptに特有の言語機能について話すときは「ClojureScript」を使用します。

##### 高レベル言語

ClojureScriptは、JavaScriptよりも高レベルの構成要素で動作します。JavaScriptでは、主に変数、ループ、条件分岐構造、オブジェクト、配列を扱います。ClojureScriptでは、式、コレクション、シーケンス、および変換を使用します。低レベルの概念から高レベルの概念へと移行することで、生産性を高めることができます。

![language-hierarchy.png](imgs0/language-hierarchy.png)

各抽象度を定義する機能

より高いレベルで作業すると、いくつかの興味深いことが起こります。まず、あるタスクを達成するために必要なコード数が減り、初期開発とデバッグ/メンテナンスの両方に役立ちます。2つ目は、コードの構造が問題領域に近いものになり、後から見ても理解しやすいものになります。3つ目は、技術的な実装問題ではなく、ドメインの問題について考えることができるようになることです。これらの要素により、アプリケーションの初期開発段階と保守段階の両方で、生産性を大幅に向上させることができます。

あるタスクを達成するために書くコードの量が減ると、いくつかのメリットがあります。まず、たくさんのコードを書くよりも、少しのコードを書いた方が早いことは言うまでもありません。通常、コードの設計や計画には、実際に書くよりも多くの時間が費やされますが、自分のアイデアをコードに変換するために必要なキーストロークの数に悩まされたくはありません。次に、コードの行数が少なければバグも少なくなります。新機能の開発よりもバグの修正に時間を使いたいという開発者は、稀有な存在であるか、存在しないかのどちらかです。ClojureScriptのような高級言語の簡潔さは、バグが隠れる場所が少ないことを意味し、その結果、前進することに時間を費やすことができます。

##### ボイラープレートの削減

JavaScriptで達成したい単純なタスク、たとえばオブジェクトのディープクローンを実行したいと思ったときに、バニラJavaScriptや利用可能なライブラリを使ってそれを行う方法を思い出すためにGoogle検索をしなければならなかったことは数え切れません。たいていの場合、StackOverflowのスレッドを何度も見て、その例をコピーして別のプロジェクトの「utils」ファイルに貼り付けることになります。lodash（そして歴史好きの方にはjQuery）のようなライブラリは、JavaScriptの一般的なユーティリティの不足を補うのに役立ちますが、堅牢な標準ライブラリの機能を得るためには、言語そのものを超えて探さなければならないという問題を解決するものではありません。

ほとんどの作業にサードパーティ製のライブラリを使用しなければならないという問題は、ライブラリを追加するたびにページの読み込みに時間がかかるため、ブラウザにとっては特別な問題です。この問題に加えて、ほとんどのウェブアプリケーションでは、少なくとも低速ネットワークのモバイルクライアントを考慮する必要があります。ウェブのように1バイトが重要な場合、限られた実用性のために別のライブラリを含めるか、必要な機能をゼロから書くかという問題に常に直面しています。

最後に、JavaScriptの開発者は、ブラウザの互換性の問題という現実に常に直面しなければなりません。選択肢としては、サポートしたいブラウザの最小公倍数をターゲットにする（開発者の生産性を向上させる言語機能を逃してしまう）、ライブラリを取り込む（ページサイズが大幅に増加する）、ブラウザ検出を実装してブラウザ固有の部分をゼロから書く（ブラウザハックに伴う複雑さが増す）、などがあります。これらの選択肢はあまり魅力的ではありませんし、開発者の生産性、パフォーマンス、複雑さの間でトレードオフをする必要はありません。これらを犠牲にすることなくブラウザ互換性の問題を解決するためには、JavaScript自体の外に目を向ける必要があります。

一方、ClojureScriptには、コレクション、文字列、数学、状態管理、JavaScriptの相互運用性などを扱うデータ構造や関数が豊富に用意されています。さらに、ClojureScriptは、GoogleのClosure（"j "ではなく "s"）ライブラリの上に構築されており、GmailやGoogle Docsなどのアプリケーションを動かすのと同じツールを指先で操作することができます。GmailやGoogle Docsのようなアプリケーションを動かすのと同じツールが手元にあります。これだけ多くのツールを自由に使えるのですから、必要なユーティリティーコードは最小限であることがわかるでしょう。最後に、ClojureScriptは、広くサポートされているJavaScriptのサブセットにコンパイルされるので、ブラウザの互換性の問題はあまりありません。ClojureScriptは、「配管」から焦点を外し、作業しているドメインの興味深い問題にもっと集中することができます。

##### デフォルトで不変のデータ

関数型プログラミングの基本的なコンセプトの1つとして、不変データについて説明しました。JavaScriptコミュニティの多くは不変データの価値を認識し始めていますが、JavaScriptで不変データを扱うことはまだネイティブではなく、やや面倒に感じるかもしれません。immerやImmutable.jsのようなライブラリを使えば、JavaScriptから不変データの利点を得ることができますが、やはり現在のところ、この言語にはネイティブサポートがありません。

しかし、ClojureScriptでは、状況は逆転しています。デフォルトのデータ構造はすべて不変であり、変更可能なオブジェクトを扱うためにはわざわざ出かける必要があります。これは、ClojureScriptが非常に意見の分かれるところですが、ClojureScriptが推進するプログラミングのスタイルは、バグを減らし、すでに見たように、ユーザーインターフェイスを最適化することにつながります。ClojureScriptのデータ構造の使用に慣れてしまえば、可変型オブジェクトや配列に戻ることは異常なことのように感じられ、危険なことのようにさえ感じられるでしょう。

##### コンパイラによる最適化

コンパイル言語の利点は、生成されるJavaScriptコードに最適化を実装できることです。高レベルの言語が、低レベルの言語の速度、リソース使用量、コンパイルされたコードサイズのいずれかに匹敵することはまれです。しかし、ClojureScriptは、しばしば手書きのJavaScriptと同じ速さで動作するJavaScriptを生成することができます。不変のデータ構造は、通常、より多くのメモリを消費し、生のオブジェクトや配列よりも遅くなりますが、これらのデータ構造によって得られるUIの最適化により、ClojureScriptのインターフェースは、対応するJavaScriptのインターフェースよりも効果的に速くなります。

JavaScriptプログラマにとって非常に重要な指標の1つがコードサイズです。サーバーサイド環境で作業している場合、コードサイズは通常は気になりません。コードはディスクから読み込まれ、すぐにメモリに読み込まれます。しかし、フロントエンドのJavaScriptアプリケーションでは、通常、コードはインターネット経由で読み込まれ、低帯域幅のモバイルネットワークを経由する可能性もあります。このような状況では、すべてのバイトが重要になります。私たちは、コードに手間をかけ、わかりやすさを犠牲にしてでも、できるだけ小さくすることに慣れています。最小化の効果は絶大ですが、それでもライブラリを増やすことには注意が必要です。多くの場合、ライブラリによって追加される利益は、ページのロード時間に追加される数キロバイトによって相殺されます。

ClojureScriptコンパイラの最も興味深い機能の1つは、Google Closureモジュールを生成し、Closure Compilerを利用してJavaScriptを最適化することです。ClojureScriptコンパイラは、生成するJavaScriptが有効なGoogle Closureモジュールであることを保証しているので、プロダクションアセットを準備する際にClosure Compilerの最も積極的な最適化を安全に利用することができます。空白の削除や変数名の変更といった典型的なものに加え、Closure Compilerはコードベース全体を分析し、決して呼び出されることのないコードパスを削除します。実質的には、大規模なライブラリを取り込み、そのライブラリから数個の関数を使用するだけで、それらの関数とその関数が呼び出す関数だけがコードベースに含まれることになります。コードサイズが非常に重要な環境では、これは明らかに大きな利点です。

**クイックレビュー**

- ほとんどのJavaScriptプロジェクトで、自分が書いているコードに思い当たる節はありませんか？これらの問題は、より完全な標準ライブラリがあれば解決するでしょうか？
- JavaScriptにコンパイルされる言語で作業することのメリットは何ですか？ デメリットは何ですか？


#### ClojureにJavaScriptが必要な理由

Clojure言語が便利であると同時に、JavaScriptを必要とします。JavaScriptがClojure言語のために可能にする最も重要なことは、クライアントサイドのWeb開発、ライブラリや技術の豊富なエコシステム、そしてJava仮想マシンよりも小さなフットプリントを持つ、はるかに軽量なプラットフォームです。とはいえ、ClojureScriptはJavaScriptにコンパイルされているので、クライアント、サーバー、デスクトップ、IoT（Internet of Things）デバイスなど、JavaScriptが動作する場所で動作します。

##### クライアントサイドの開発

Clojureはもともとサーバーサイドの言語でした。確かにSwingや他のJava UIツールキットを使ってデスクトップGUIを書くことは可能でしたが、Clojureの大部分はサーバー用に書かれていました。Clojureはサーバーサイドのプログラミング言語としても優れていますが、これまで述べてきたように、UI開発にも大きなメリットをもたらします。ClojureScriptの登場により、Clojureは、サーバーでもクライアントでも、ほぼすべてのアプリケーションに使用できる汎用言語となりました。リッチ・ヒッキー氏がClojureScriptを発表した際に述べたように、"Clojure rocks, and JavaScript reaches. "です。

さらに、ElectronやNW.jsのような技術では、デスクトップアプリケーションをJavaScriptで書くという選択肢があります。また、ClojureScriptはJavaScriptにコンパイルされるので、同じ技術を利用してClojureScriptでもデスクトップアプリケーションを書くことができます。Clojure自体は、JavaのGUIアプリケーションを書くことができますが、多くの開発者は、これらのJavaScriptのUI技術によって得られる軽量なスタイルを好みます。

> デスクトップでのClojureScript
>
>    Clojure言語をサポートする最も人気のあるエディタの一つであるLightTableエディタの開発者は、ClojureScriptを使用してUIを構築し、Electron内に配置することを選択しました。これにより、従来のデスクトップUIのような複雑さはなく、非常に柔軟でカスタマイズ可能なUIを構築することができました。

最後に、JavaScriptアプリケーションをモバイルアプリケーションとして動作させることができる技術がいくつかあります。この分野ではReact Nativeが注目を集めており、ほとんどのClojureScriptのUIがReactをプラットフォームとして構築されていることから、ClojureScriptにとっても優れた選択肢となっています。このJavaScriptモバイルネイティブアプリの分野は比較的新しい領域ですが、多くの期待が寄せられています。次世代のモバイルアプリは、JavaScriptアプリが主流になるかもしれません。つまり、ClojureScriptはモバイルクライアントにとっても第一級の市民になるということです。

##### JavaScriptのエコシステム

JavaScriptは単なる言語ではありません。ベストプラクティス、ライブラリ、ツール、開発プロセスについて意見を持つコミュニティです。ClojureScriptはこのコミュニティの中で生きています。私たちClojureScript開発者は、利用可能な膨大な数のJavaScriptライブラリの恩恵を受けていますが、JavaScriptが提供するより重要な恩恵は、そのコミュニティです。私たちは、コミュニティの集合的な経験から、フロントエンド開発の良い点、悪い点、そして醜い点を学ぶことができます。JavaScriptとClojureの関係はまさに共生関係にあり、両方のコミュニティが他方のアイデアや洞察力から恩恵を受けています。

ClojureScriptが非常に実用的で便利な言語であることを見てきましたが、現実には、関数型プログラミング言語が現役プログラマーの関心事から離れてしまうのは簡単なことです。理論的な言語は便利ですし、ほとんどの便利なプログラミング言語の機能は研究プロジェクトから始まったものですが、理論的な純粋さはウェブアプリを書くときの最重要課題ではありません。しかし、ウェブアプリケーションを書くときには、理論的な純粋さは最優先事項ではありません。「すぐに使える」ことの方がはるかに優先事項であり、JavaScriptはその誕生以来、できるだけ簡単に物事を終わらせることを目的としてきました。JavaScriptコミュニティの一員であることは、ClojureScriptがより良いWebアプリケーションを構築するための実用的な関心事に焦点を当てることに役立ちます。

##### 小さなフットプリント

JVMは、高性能なクロスプラットフォーム・アプリケーションを開発するための優れたプラットフォームです。しかし、リソースに制約のある環境での実行やスクリプトの実行に関しては、それほど優れているわけではありません。「Write once, run anywhere」というスローガンは、サン・マイクロシステムズ社がJavaを普及させるために用いたものですが、皮肉にも「ユニバーサル」なランタイムとなったのはJavaScriptです。ブラウザ、サーバー、Raspberry Piや組み込み機器など、JavaScriptはあらゆる場所で動作します。一方、Raspberry PiのようなものでJavaを動かすことは、現実的には不可能です。ClojureScriptは、Javaが肥大化しすぎているアプリケーションを書くのに最適な選択肢です。ほとんどすべてのデバイス上で動作する能力は、JavaScriptの「リーチ」のもう一つの側面であり、ClojureScriptから利用することができます。

スクリプティングは、Javaがかなり弱い分野です。大規模なアプリケーションに組み込まれたスクリプト言語としても、システムシェルのスクリプト言語としても、Javaは大きすぎて複雑ですし、JVMの起動時間のせいで、シンプルなスクリプトのような短命のプログラムには実用的ではありません。JavaScriptは優れたスクリプティング言語です。Node.jsでは、ウェブサーバだけでなく、システムスクリプトも書くことができます。

**クイックレビュー**

- ClojureScriptの最も一般的なプラットフォームは、Web、デスクトップ、モバイル、IoTデバイスのどれですか？このプラットフォーム以外でも使用できますか？
- ClojureScriptは、既存のJavaScriptツールやライブラリとどの程度相互運用できますか？

#### まとめ

このレッスンでは、ClojureScriptとそのホストであるJavaScriptとの関係を探りました。以下のことを学びました。

- ClojureScriptがどのようにしてJavaScriptの開発経験を向上させるか
- JavaScriptの軽量でユビキタスなランタイムにより、実質的にどのようなプラットフォームでもClojureScriptを書くことができること。
- クライアントサイドのWeb開発がClojureScriptに適している理由。

さて、ClojureScriptとは何か、JavaScriptプラットフォームとどのように関連しているのかを十分に理解したところで、いよいよこの言語を実際に使ってみましょう。次のセクションでは、ClojureScriptアプリケーションを作成するプロセスを、一般的なツールやプラクティスを学びながら進めていきます。






[UP](000_00.md)
