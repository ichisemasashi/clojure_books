


付録A


# Leiningen でのビルドと開発

どのような言語でも、ソフトウェアを書くには *成果物* を生成する必要があります。成果物とは、デプロイまたは共有される実行可能ファイルやライブラリパッケージのことです。また、ビルド中のプロジェクトに確実にロードされるように、依存する成果物（*依存関係*とも呼ばれる）を管理する必要もあります。アーティファクトを管理するためのClojuristの間で最も人気のあるツールはLeiningenで、この付録ではその使い方を紹介します。また、Leiningen を使って、*プラグイン* を使って開発体験を完全に向上させる方法も学びます。

## アーティファクトエコシステム

ClojureはJava仮想マシン( JVM)上でホストされるため、ClojureアーティファクトはJARファイルとして配布されます(第12章でカバー)。Javaランドには、JARファイルを扱うための全体的なアーティファクト・エコシステムがすでにあり、Clojureはそれを使用します。*アーティファクト・エコシステム*は、公式なプログラミング用語ではありません。私は、アーティファクトを識別し配布するために使用されるツール、リソース、および規約のスイートを指すために使用しています。JavaのエコシステムはMavenビルド・ツールを中心に成長し、Clojureはこのエコシステムを使用しているため、Mavenへの参照をよく目にします。Mavenは、あらゆる種類の奇妙なプロジェクト管理タスクを実行できる巨大なツールです。 ありがたいことに、効果的なClojuristになるためにMavenologyの博士号を取得する必要はありません。あなたが知る必要がある唯一の機能は、MavenがClojureプロジェクトが準拠する成果物を識別するためのパターンを指定し、配布のために成果物を格納する単なるサーバーであるMaven *リポジトリ*でこれらの成果物をホストする方法も指定することです。

### 識別

Maven アーティファクトには、*グループ ID*、*アーティファクト ID*、および *バージョン* が必要です。 これらは *project.clj* ファイルで指定できます。1章で作成した `clojure-noob` プロジェクトの *project.clj* の最初の行は以下のようになっています：



```
(defproject clojure-noob "0.1.0-SNAPSHOT"
          
```



`clojure-noob`はプロジェクトのグループIDとアーティファクトIDの両方で、`"0.1.0-SNAPSHOT"`はそのバージョンです。一般的に、バージョンは永続的です。バージョン0.1.0の成果物をリポジトリにデプロイした場合、成果物に変更を加えて同じバージョン番号でデプロイすることはできません。バージョン番号を変更する必要があります。(多くのプログラマーはセマンティック・バージョニング・システムを好みます。 *<http://semver.org/>.* で読むことができます) もしそのバージョンが進行中であり、今後も更新し続ける予定であることを示したいのであれば、バージョン番号に`-SNAPSHOT`を付加することができます。

グループIDとアーティファクトIDを別のものにしたい場合は、次のようにスラッシュで区切ってください：



```
(defproject group-id/artifact-id "0.1.0-SNAPSHOT"
          
```



多くの場合、開発者は会社名やGitHubのユーザー名をグループIDとして使用します。

### 依存関係

あなたの*project.clj*ファイルには、プロジェクトの依存関係を列挙した次のような行も含まれます：



```
  :dependencies [[org.clojure/clojure "1.9.0"]]
          
```



もしあるライブラリを使いたいのであれば、プロジェクトの名前に使うのと同じ命名スキーマを使って、この依存関係ベクトルに追加してください。例えば、日付と時刻を簡単に操作したい場合、clj-timeライブラリを追加することができます：



```
  :dependencies [[org.clojure/clojure "1.9.0"]
            [clj-time "0.9.0"]]
          
```



次にプロジェクトを起動するとき、それを実行するかREPLを起動するかのどちらかで、Leiningenは自動的にclj-timeをダウンロードし、プロジェクト内で利用できるようにします。

Clojureコミュニティは多数の有用なライブラリを作成しました。それらを探すのに良い場所は、 *<http://www.clojure-toolbox.com>* にあるClojure Toolboxで、目的に応じてプロジェクトを分類しています。ほぼ全てのClojureライブラリは、そのREADMEの一番上に識別子を提供しており、Leiningenの依存関係に追加する方法を簡単に見つけることができます。

時にはJavaライブラリを使いたいかもしれませんが、識別子はそれほど簡単に入手できません。例えば、Apache Commons Emailを追加したい場合、このような内容のウェブページを見つけるまで、オンラインで検索しなければなりません：



```
<dependency>
            <groupId>org.apache.commons</groupId>
            <artifactId>commons-email</artifactId>
            <version>1.3.3</version>
            </dependency>
          
```



このXMLは、JavaプロジェクトがMaven識別子を通信する方法です。これをClojureプロジェクトに追加するには、`:dependencies`ベクトルを次のように変更します：



```
  :dependencies [[org.clojure/clojure "1.9.0"]
            [clj-time "0.9.0"]
            [org.apache.commons/commons-email "1.3.3"]]
          
```



メインのClojureリポジトリはClojars ( *<https://clojars.org/>* ) で、メインのJavaリポジトリはThe Central Repository ( *<http://search.maven.org/>* ) です。これは、サンフランシスコの住人がサンフランシスコを*the city*と呼ぶのと同じように、しばしば単に*Central*と呼ばれます。これらのサイトを使って、ライブラリとその識別子を見つけることができる。

自分のプロジェクトをClojarsにデプロイするには、そこでアカウントを作成し、自分のプロジェクトで `lein deploy clojars` を実行するだけでよい。このタスクは、POMファイル（ここでは触れない）やJARファイルなど、Mavenアーティファクトをリポジトリに格納するために必要なものをすべて生成する。 そして、それらをClojarsにアップロードします。

### プラグイン

Leiningenでは*プラグイン*を使うことができる。例えば、EastwoodプラグインはClojureのlintツールです。プラグインは通常、 *\$HOME/.lein/profiles.clj* ファイルで指定します。Eastwoodを追加するには、 *profiles.clj* を次のように変更します：



```
{:user {:plugins [[jonase/eastwood "0.2.1"]] }}
          
```



これにより、すべてのプロジェクトで `eastwood` Leiningen タスクが有効になり、プロジェクトのルートで `lein eastwood` を実行できるようになります。

Leiningen の GitHub プロジェクトページには、プロファイルとプラグインの使い方に関する優れたドキュメントがあり、便利なプラグインのリストもあります。

## まとめ

この付録では、Mavenとは何か、ClojureとMavenの関係といった、重要だが調べるのが難しいプロジェクト管理の側面に焦点を当てました。Leiningen を使ってプロジェクトに名前を付け、依存関係を指定し、Clojure にデプロイする方法を紹介しました。 Leiningenは、実際にコードを書くことを伴わないソフトウェア開発タスクのために多くの機能を提供します。もっと詳しく知りたい方は、オンラインチュートリアルの *<https://github.com/technomancy/leiningen/blob/stable/doc/TUTORIAL.md>* をチェックしてください。



